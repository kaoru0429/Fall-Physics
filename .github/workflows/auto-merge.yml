name: Auto Merge Jules PR

on:
  pull_request:
    types: [opened, synchronize, labeled]
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    
    # åªè™•ç† Jules çš„ PR æˆ–æœ‰ auto-merge æ¨™ç±¤çš„ PR
    if: |
      github.event.pull_request.user.login == 'jules[bot]' || 
      contains(github.event.pull_request.labels.*.name, 'auto-merge')
    
    steps:
      - name: ğŸ” æª¢æŸ¥ PR ç‹€æ…‹
        id: pr-status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            console.log('PR ç‹€æ…‹:', pr.mergeable_state);
            core.setOutput('mergeable', pr.mergeable_state === 'clean' || pr.mergeable_state === 'unstable');

      - name: â³ ç­‰å¾… Vercel éƒ¨ç½²å®Œæˆ
        if: steps.pr-status.outputs.mergeable == 'true'
        uses: patrickedqvist/wait-for-vercel-preview@v1.3.1
        id: vercel-preview
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          max_timeout: 300
          check_interval: 10

      - name: ğŸ§ª æ¸¬è©¦é è¦½éƒ¨ç½²
        if: steps.vercel-preview.outputs.url != ''
        run: |
          echo "ğŸ”— æ¸¬è©¦ç¶²å€: ${{ steps.vercel-preview.outputs.url }}"
          
          # æ¸¬è©¦é¦–é 
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.vercel-preview.outputs.url }}")
          if [ $HTTP_CODE -eq 200 ]; then
            echo "âœ… é¦–é è¼‰å…¥æˆåŠŸ"
          else
            echo "âŒ é¦–é è¼‰å…¥å¤±æ•— (HTTP $HTTP_CODE)"
            exit 1
          fi
          
          # æ¸¬è©¦ç« ç¯€é é¢
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.vercel-preview.outputs.url }}/chapter/00-tutorial")
          if [ $HTTP_CODE -eq 200 ]; then
            echo "âœ… ç« ç¯€é é¢è¼‰å…¥æˆåŠŸ"
          else
            echo "âŒ ç« ç¯€é é¢è¼‰å…¥å¤±æ•— (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: âœ… è‡ªå‹•åˆä½µ
        if: success()
        run: |
          gh pr merge --auto --squash --delete-branch ${{ github.event.pull_request.number }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ’¬ ç•™è¨€é€šçŸ¥ï¼ˆæˆåŠŸï¼‰
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.vercel-preview.outputs.url }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… è‡ªå‹•åˆä½µå®Œæˆï¼
              
              ### ğŸ§ª æ¸¬è©¦çµæœ
              - âœ… é¦–é æ­£å¸¸è¼‰å…¥
              - âœ… ç« ç¯€é é¢æ­£å¸¸é‹ä½œ
              - âœ… Vercel é è¦½éƒ¨ç½²æˆåŠŸ
              
              ### ğŸ”— é€£çµ
              - **é è¦½ç¶²å€**: ${previewUrl}
              - **æ­£å¼ç¶²å€**: https://fall-physics-mu.vercel.app
              
              ---
              _ğŸ¤– æ­¤ PR ç”±è‡ªå‹•åŒ–ç³»çµ±è™•ç†_`
            })

      - name: âš ï¸ ç•™è¨€é€šçŸ¥ï¼ˆå¤±æ•—ï¼‰
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ è‡ªå‹•åˆä½µå¤±æ•—
              
              è«‹æª¢æŸ¥ [Actions æ—¥èªŒ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) æŸ¥çœ‹è©³ç´°éŒ¯èª¤ã€‚
              
              å¯èƒ½çš„åŸå› ï¼š
              - Vercel éƒ¨ç½²å¤±æ•—
              - é è¦½ç¶²å€æ¸¬è©¦æœªé€šé
              - åˆä½µè¡çª
              
              ---
              _éœ€è¦äººå·¥ä»‹å…¥è™•ç†_`
            })
